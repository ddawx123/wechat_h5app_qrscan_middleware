<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>扫码服务中间件</title>
    <link href="css/sweetalert.min.css" rel="stylesheet" />
</head>
<body style="text-align: center">
    <h2>请等待唤起扫码</h2>
    <script src="js/eruda.min.js" type="text/javascript"></script>
    <script type="text/javascript">eruda.init();</script>
    <script src="js/sweetalert.min.js" type="text/javascript"></script>
    <script src="js/xhr.js" type="text/javascript"></script>
    <script src="js/jweixin-1.6.0.js" type="text/javascript"></script>
    <script src="js/dingtalk.open-2.13.42.js" type="text/javascript"></script>
    <script type="text/javascript">
        // 用于微信内置浏览器内自动屏蔽右上角所有扩展选项，防止用户通过微信直接转跳至系统浏览器查看平台网址
        if (typeof(WeixinJSBridge) !== 'undefined') {
            setTimeout(function() {
                document.addEventListener("WeixinJSBridgeReady", function() {
                    WeixinJSBridge.call("hideOptionMenu");
                    WeixinJSBridge.call("hideAllNonBaseMenuItem");
                }, false);
                WeixinJSBridge.call("hideOptionMenu");
                WeixinJSBridge.call("hideAllNonBaseMenuItem");
            }, 300);
        }
    </script>
    <script type="text/javascript">
        let debugMode = false; // 仅调试环境使用，生产环境请务必调整为false
        let prepData = {
            requestUrl: window.location.href,
            nonceStr: btoa(Math.random()),
            timeStamp: new Date().getTime()
        };
        const WECHAT_UA = 'micromessenger';
        const DINGTALK_UA = 'dingtalk';
        const ALIPAY_UA = 'alipayclient';
        document.onreadystatechange = function () {
            if (document.readyState === 'complete') {
                if (navigator.userAgent.toLowerCase().indexOf(WECHAT_UA) !== -1) {
                    initWeChat();
                } else if (navigator.userAgent.toLowerCase().indexOf(DINGTALK_UA) !== -1) {
                    initDingTalk();
                } else if (navigator.userAgent.toLowerCase().indexOf(ALIPAY_UA) !== -1) {
                    swal({
                        title: '不支持的客户端',
                        text: '检测到您正在支付宝内访问此应用，如需使用阿里系应用生态，请更换移动端钉钉访问此应用！',
                        type: 'error',
                        showCancelButton: false,
                        showConfirmButton: true,
                        confirmButtonText: '好'
                    });
                } else {
                    console.log(navigator.userAgent);
                    swal({
                        title: '不支持的客户端',
                        text: '目前仅支持移动端微信、钉钉内访问此应用！',
                        type: 'error',
                        showCancelButton: false,
                        showConfirmButton: true,
                        confirmButtonText: '好'
                    });
                }
            }
        }
        function initWeChat() {
            xhr.request({
                url: 'https://api.dscitech.com/api/wxJsSignature',
                method: 'POST',
                data: prepData,
                headers: [{
                    key: 'Content-Type',
                    val: 'application/json'
                }, {
                    key: 'Cache-Control',
                    val: 'no-cache'
                }],
                beforeSend: function () {
                    console.log('Loading data by network request.');
                    swal({
                        title: '请稍候',
                        text: '正在加载扫码组件',
                        imageUrl: 'img/loading.gif',
                        showCancelButton: false,
                        showConfirmButton: false
                    })
                },
                afterResponse: function (res) {
                    if (res.code !== 200) {
                        swal({
                            title: '未获得扫码权限',
                            text: '微信JSAPI后端异常 ' + res.msg + ' ' + res.data.errmsg + ' ' + res.data.errcode,
                            type: 'error',
                            showCancelButton: false,
                            showConfirmButton: true,
                            confirmButtonText: '返回'
                        }, function () {
                            if (typeof(WeixinJSBridge) !== 'undefined') {
                                WeixinJSBridge.call("closeWindow");
                            } else {
                                console.log('非微信内部浏览容器，跳过调用私有API');
                                window.close();
                            }
                        });
                    } else {
                        // 开始注入微信JSAPI特性配置
                        wx.config({
                            debug: debugMode,
                            appId: 'wx9d02b81c997dc938',
                            timestamp: prepData.timeStamp,
                            nonceStr: prepData.nonceStr,
                            signature: res.data.js_sign,
                            jsApiList: ["checkJsApi", "onMenuShareTimeline", "onMenuShareAppMessage", "onMenuShareQQ", "onMenuShareWeibo", "onMenuShareQZone", "hideMenuItems", "showMenuItems", "hideAllNonBaseMenuItem", "showAllNonBaseMenuItem", "translateVoice", "startRecord", "stopRecord", "onVoiceRecordEnd", "playVoice", "onVoicePlayEnd", "pauseVoice", "stopVoice", "uploadVoice", "downloadVoice", "chooseImage", "previewImage", "uploadImage", "downloadImage", "getNetworkType", "openLocation", "getLocation", "hideOptionMenu", "showOptionMenu", "closeWindow", "scanQRCode", "chooseWXPay", "openProductSpecificView", "addCard", "chooseCard", "openCard"],
                            openTagList: ['wx-open-launch-weapp']
                        });
                        // 开始注册各类Hybrid应用事件
                        wx.ready(function () {
                            wx.hideOptionMenu();
                            wx.hideAllNonBaseMenuItem();
                            wx.scanQRCode({
                                needResult: 1,
                                scanType: ['qrCode', 'barCode'],
                                success: function (res) {
                                    procScanResult(res.resultStr, function () {
                                        wx.closeWindow();
                                    });
                                },
                                fail: function (e) {
                                    console.log(e);
                                    swal({
                                        title: '扫码时出错',
                                        text: '扫码失败，请重试',
                                        type: 'error',
                                        showCancelButton: false,
                                        showConfirmButton: true,
                                        confirmButtonText: '返回'
                                    }, function () {
                                        wx.closeWindow();
                                    });
                                },
                                cancel: function () {
                                    swal({
                                        title: '扫码取消',
                                        text: '客户端已取消扫码',
                                        type: 'info',
                                        showCancelButton: false,
                                        showConfirmButton: true,
                                        confirmButtonText: '返回'
                                    }, function () {
                                        wx.closeWindow();
                                    });
                                }
                            });
                        });
                        wx.error(function () {
                            swal({
                                title: '启动扫码时出错',
                                text: '微信JSAPI权限注入失败，暂无法调用客户端扫码能力。',
                                type: 'error',
                                showCancelButton: false,
                                showConfirmButton: true,
                                confirmButtonText: '返回'
                            }, function () {
                                if (typeof(WeixinJSBridge) !== 'undefined') {
                                    WeixinJSBridge.call("closeWindow");
                                } else {
                                    console.log('非微信内部浏览容器，跳过调用私有API');
                                    window.close();
                                }
                            });
                        });
                    }
                }
            });
        }
        function initDingTalk() {
            dd.ready(function() {
                dd.biz.util.scan({
                    type: "all",
                    onSuccess: function (r) {
                        procScanResult(r.text, function () {
                            dd.biz.navigation.close();
                        });
                    },
                    onFail: function (e) {
                        if (e.errorCode === 10) {
                            swal({
                                title: '扫码取消',
                                text: '客户端已取消扫码',
                                type: 'info',
                                showCancelButton: false,
                                showConfirmButton: true,
                                confirmButtonText: '返回'
                            }, function () {
                                dd.biz.navigation.close();
                            });
                        } else {
                            swal({
                                title: '扫码异常',
                                text: '扫码时出错，客户端返回的错误信息已附加至调试日志。',
                                type: 'warning',
                                showCancelButton: false,
                                showConfirmButton: true,
                                confirmButtonText: '返回'
                            }, function () {
                                console.log(e);
                            });
                        }
                    }
                });
            });
        }
        /**
         * 处理扫码结果
         * @param result
         * @param callback
         * @return mixed
         */
        function procScanResult(result, callback = {}) {
            if (result.indexOf('https://sxbuszp.com/station/') >= 0) { // 命中绍兴公交
                let stationId = result.split('https://sxbuszp.com/station/')[1];
                top.location.replace('http://city.dscitech.com/#/bus/detail?regionId=330600&stationId=' + stationId);
            } else if (result.indexOf('https://appactive.ibuscloud.com/') >= 0) { // 命中杭州公交
                let stationInfo = result.split('cn=')[1].split('&c=');
                top.location.replace('http://city.dscitech.com/#/bus/detail?regionId=' + stationInfo[1] + '&stationId=' + stationInfo[0]);
            } else {
                console.log(result);
                swal({
                    title: '发现未适配码',
                    text: '中间件暂未适配当前扫码内容，请访问开放平台查看对接信息。',
                    type: 'warning',
                    showCancelButton: false,
                    showConfirmButton: true,
                    confirmButtonText: '返回'
                }, function () {
                    callback();
                });
            }
        }
    </script>
</body>
</html>
